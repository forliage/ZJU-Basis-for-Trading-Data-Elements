### 一、问题回顾与基础概念

首先，我们回顾一下问题背景和 Shapley 值的核心概念。

#### 1. 问题背景：分摊美元博弈

在 Lecture 5 中，我们有三个合作商 A, B, C。他们各自以及两两合作、三方合作能产生的年收入（价值）如下，这构成了合作博弈的**特征函数 `v(S)`**：

*   **单个成员联盟的价值**:
    *   $v(\{A\}) = 17$
    *   $v(\{B\}) = 15$
    *   $v(\{C\}) = 18$
*   **两个成员联盟的价值**:
    *   $v(\{A, B\}) = 35$
    *   $v(\{A, C\}) = 38$
    *   $v(\{B, C\}) = 36$
*   **大联盟的价值**:
    *   $v(\{A, B, C\}) = 56$
*   **空联盟的价值**:
    *   $v(\Phi) = 0$

#### 2. Shapley 值核心思想

Shapley 值旨在为每位参与者分配一个“公平”的收益，这个公平性体现在该收益等于该参与者在所有可能加入联盟的**次序**下，为其所加入的联盟带来的**边际贡献**的期望值。

#### 3. Shapley 值计算公式

我们主要使用基于排列的直观公式来计算：
$$
SV_i(N, v) = \frac{1}{|N|!} \sum_{\sigma \in S_N} [v(P_i(\sigma) \cup \{i\}) - v(P_i(\sigma))]
$$
其中：
*   $N$ 是全体参与者的集合，这里 $N = \{A, B, C\}$, 所以 $|N|! = 3! = 6$。
*   $S_N$ 是 $N$ 中所有成员的所有可能排列的集合。
*   $\sigma$ 是 $S_N$ 中的一个具体排列。
*   $P_i(\sigma)$ 是在排列 $\sigma$ 中，位于参与者 $i$ **之前**的所有参与者的集合。
*   $v(P_i(\sigma) \cup \{i\}) - v(P_i(\sigma))$ 就是参与者 $i$ 在该排列下的边际贡献。

### 二、详细计算过程

我们来计算 $N = \{A, B, C\}$ 的所有 $3! = 6$ 种排列，并计算每位合作商在每种排列下的边际贡献。

**所有可能的排列 ($\sigma$)**:
1.  (A, B, C)
2.  (A, C, B)
3.  (B, A, C)
4.  (B, C, A)
5.  (C, A, B)
6.  (C, B, A)

---

#### 1. 计算合作商 A 的 Shapley 值 ($SV_A$)

我们逐一分析 A 在 6 种排列中的边际贡献：

*   **排列 (A, B, C)**: A 排在第一位。
    *   A 前面的成员集合 $P_A(\sigma) = \Phi$ (空集)。
    *   边际贡献 = $v(P_A(\sigma) \cup \{A\}) - v(P_A(\sigma)) = v(\{A\}) - v(\Phi) = 17 - 0 = 17$。

*   **排列 (A, C, B)**: A 排在第一位。
    *   $P_A(\sigma) = \Phi$。
    *   边际贡献 = $v(\{A\}) - v(\Phi) = 17 - 0 = 17$。

*   **排列 (B, A, C)**: A 排在第二位。
    *   A 前面的成员集合 $P_A(\sigma) = \{B\}$。
    *   边际贡献 = $v(\{B\} \cup \{A\}) - v(\{B\}) = v(\{A, B\}) - v(\{B\}) = 35 - 15 = 20$。

*   **排列 (C, A, B)**: A 排在第二位。
    *   $P_A(\sigma) = \{C\}$。
    *   边际贡献 = $v(\{C\} \cup \{A\}) - v(\{C\}) = v(\{A, C\}) - v(\{C\}) = 38 - 18 = 20$。

*   **排列 (B, C, A)**: A 排在第三位。
    *   $P_A(\sigma) = \{B, C\}$。
    *   边际贡献 = $v(\{B, C\} \cup \{A\}) - v(\{B, C\}) = v(\{A, B, C\}) - v(\{B, C\}) = 56 - 36 = 20$。

*   **排列 (C, B, A)**: A 排在第三位。
    *   $P_A(\sigma) = \{C, B\}$。
    *   边际贡献 = $v(\{C, B\} \cup \{A\}) - v(\{C, B\}) = v(\{A, B, C\}) - v(\{B, C\}) = 56 - 36 = 20$。

**A 的总边际贡献**: $17 + 17 + 20 + 20 + 20 + 20 = 114$
**A 的 Shapley 值**:
$$
SV_A = \frac{1}{6} \times 114 = 19
$$

---

#### 2. 计算合作商 B 的 Shapley 值 ($SV_B$)

*   **排列 (A, B, C)**: 边际贡献 = $v(\{A, B\}) - v(\{A\}) = 35 - 17 = 18$。
*   **排列 (A, C, B)**: 边际贡献 = $v(\{A, C, B\}) - v(\{A, C\}) = 56 - 38 = 18$。
*   **排列 (B, A, C)**: 边际贡献 = $v(\{B\}) - v(\Phi) = 15 - 0 = 15$。
*   **排列 (B, C, A)**: 边际贡献 = $v(\{B\}) - v(\Phi) = 15 - 0 = 15$。
*   **排列 (C, A, B)**: 边际贡献 = $v(\{C, A, B\}) - v(\{C, A\}) = 56 - 38 = 18$。
*   **排列 (C, B, A)**: 边际贡献 = $v(\{C, B\}) - v(\{C\}) = 36 - 18 = 18$。

**B 的总边际贡献**: $18 + 18 + 15 + 15 + 18 + 18 = 102$
**B 的 Shapley 值**:
$$
SV_B = \frac{1}{6} \times 102 = 17
$$

---

#### 3. 计算合作商 C 的 Shapley 值 ($SV_C$)

*   **排列 (A, B, C)**: 边际贡献 = $v(\{A, B, C\}) - v(\{A, B\}) = 56 - 35 = 21$。
*   **排列 (A, C, B)**: 边际贡献 = $v(\{A, C\}) - v(\{A\}) = 38 - 17 = 21$。
*   **排列 (B, A, C)**: 边际贡献 = $v(\{B, A, C\}) - v(\{B, A\}) = 56 - 35 = 21$。
*   **排列 (B, C, A)**: 边际贡献 = $v(\{B, C\}) - v(\{B\}) = 36 - 15 = 21$。
*   **排列 (C, A, B)**: 边际贡献 = $v(\{C\}) - v(\Phi) = 18 - 0 = 18$。
*   **排列 (C, B, A)**: 边际贡献 = $v(\{C\}) - v(\Phi) = 18 - 0 = 18$。

**C 的总边际贡献**: $21 + 21 + 21 + 21 + 18 + 18 = 120$
**C 的 Shapley 值**:
$$
SV_C = \frac{1}{6} \times 120 = 20
$$

---

#### 4. 结果汇总与验证

*   $SV_A = 19$
*   $SV_B = 17$
*   $SV_C = 20$

**验证 (有效率性)**: 所有参与者的 Shapley 值之和应等于大联盟的总价值。
$$
SV_A + SV_B + SV_C = 19 + 17 + 20 = 56
$$
$v(\{A, B, C\}) = 56$
二者相等，计算正确。

### 三、三合作商 Shapley 值通解推导

现在，我们推导一个普遍适用于任意三个参与者合作博弈的 Shapley 值公式。设三位参与者为 1, 2, 3。

我们使用另一个等价的 Shapley 值公式（基于联盟的公式）进行推导，因为它更具代数性：
$$
SV_i(N, v) = \sum_{S \subseteq N \setminus \{i\}} \frac{|S|! (n - |S| - 1)!}{n!} [v(S \cup \{i\}) - v(S)]
$$
其中 $n = |N| = 3$。

我们来推导参与者 **1** 的 Shapley 值 $SV_1$。此时 $N \setminus \{1\} = \{2, 3\}$。我们需要考虑 $\{2, 3\}$ 的所有子集 $S$：
1.  **当 $S = \Phi$ (空集) 时**:
    *   $|S|=0$。
    *   权重为 $\frac{0!(3-0-1)!}{3!} = \frac{1 \times 2!}{6} = \frac{2}{6} = \frac{1}{3}$。
    *   贡献项为 $v(\{1\}) - v(\Phi)$。

2.  **当 $S = \{2\}$ 时**:
    *   $|S|=1$。
    *   权重为 $\frac{1!(3-1-1)!}{3!} = \frac{1 \times 1!}{6} = \frac{1}{6}$。
    *   贡献项为 $v(\{1, 2\}) - v(\{2\})$。

3.  **当 $S = \{3\}$ 时**:
    *   $|S|=1$。
    *   权重为 $\frac{1!(3-1-1)!}{3!} = \frac{1 \times 1!}{6} = \frac{1}{6}$。
    *   贡献项为 $v(\{1, 3\}) - v(\{3\})$。

4.  **当 $S = \{2, 3\}$ 时**:
    *   $|S|=2$。
    *   权重为 $\frac{2!(3-2-1)!}{3!} = \frac{2 \times 0!}{6} = \frac{2}{6} = \frac{1}{3}$。
    *   贡献项为 $v(\{1, 2, 3\}) - v(\{2, 3\})$。

将以上所有项加权求和，得到参与者 **1** 的 Shapley 值通解：
$$
SV_1 = \frac{1}{3}[v(\{1\}) - v(\Phi)] + \frac{1}{6}[v(\{1, 2\}) - v(\{2\})] + \frac{1}{6}[v(\{1, 3\}) - v(\{3\})] + \frac{1}{3}[v(\{1, 2, 3\}) - v(\{2, 3\})]
$$
将系数 $\frac{1}{6}$ 提出，整理可得：
$$
SV_1 = \frac{1}{6} \Big( 2[v(\{1\}) - v(\Phi)] + [v(\{1, 2\}) - v(\{2\})] + [v(\{1, 3\}) - v(\{3\})] + 2[v(\{1, 2, 3\}) - v(\{2, 3\})] \Big)
$$

通过对称性，我们可以直接写出参与者 **2** 和 **3** 的 Shapley 值通解：

**参与者 2 的通解 $SV_2$**:
$$
SV_2 = \frac{1}{6} \Big( 2[v(\{2\}) - v(\Phi)] + [v(\{1, 2\}) - v(\{1\})] + [v(\{2, 3\}) - v(\{3\})] + 2[v(\{1, 2, 3\}) - v(\{1, 3\})] \Big)
$$

**参与者 3 的通解 $SV_3$**:
$$
SV_3 = \frac{1}{6} \Big( 2[v(\{3\}) - v(\Phi)] + [v(\{1, 3\}) - v(\{1\})] + [v(\{2, 3\}) - v(\{2\})] + 2[v(\{1, 2, 3\}) - v(\{1, 2\})] \Big)
$$

这些就是任意三参与者合作博弈中 Shapley 值的通用计算公式。你可以将“分摊美元博弈”的数值代入这些通解进行验证，会得到与前面分步计算完全相同的结果。